name: 'Trigger Deploy'
description: ''
inputs:
  VERSION:
    required: true
  GH_PAT:
    required: true
  PATH_TO_TERRAFORM_FILE:
    required: true
  PREFIX:
    required: true
runs:
  using: 'composite'
  steps:
    - uses: actions/checkout@v4
      with:
        persist-credentials: false
    - run: |
        VERSION=${{ inputs.VERSION }}
        
        git clone https://x-access-token:${{ inputs.GH_PAT }}@github.com/tsai-tech/terraform.git
        cd terraform
        
        TARGET_FILE="${{ inputs.PATH_TO_TERRAFORM_FILE }}"
        PREFIX="${{ inputs.PREFIX }}"

        sed -E -i "s/(${PREFIX}_version[[:space:]]*=[[:space:]]*\")[^\"]+(\")/\1${VERSION}\2/" "$TARGET_FILE"

        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        git add "$TARGET_FILE"
        git commit -m "chore: update ${{ github.repository }} version to ${VERSION}"
        git push
      shell: bash
